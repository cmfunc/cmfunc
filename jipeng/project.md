# 激碰-小程序

交友软件的需求：第一基于时空交集找人，第二基于外型好感度找人。
## 运营
### 导流

经过给同性恋建微信群，发现帮助别人更能引起别人的注意。但是，有个问题，这些通过微信群进入的twitter朋友，有很大一部分都不爱发言，而且怀疑他们都是用的小号。他们的目标是为了寻求性和刺激。因为微信加群限制，未通过绑定银行卡实名认证的用户，是无法正常加群的，所以用小号的可能性小，但是有可能是多个微信号，加群的号不是主使用账号。
### 玩法
如何消除陌生人约见的恐惧？HIV、社恐、生命财产安全？需要考虑让同志群体觉醒。人的性欲周期是几天？
### 人群分析
Twitter吸引进群的人，大部分是没去过浴室的人；一些有经验的人，他们有自己的圈子和群，去的时候都会一起去；所以，给这部分人只需要提供一个场所信息就行，对于他们的交友需求，需要额外处理；
## 功能板块
客户端功能：
一、地图
包含地图IM、地图导航
二、群聚活动
野聚、废墟文化、好玩的城市空地、荒地；
三、娱乐场所推荐
可与商家进行推广合作；
包含对地点推荐、夸奖、吐槽、宣泄；必须包含信息：地点（标记地图位置）和描述（文字、图片、视频、语音）；
四、地图广播
全员用户接收地图广播弹幕消息；个性化推荐给指定用户广播弹幕；
五、地图动态
用户在地图上，发布动态，用户记录当前所在位置，自己的心情和发生的事情；
后台管理：
封禁用户、商业化运营功能；
## 技术分析
### 地图：
完全依赖微信小程序地图组件的接口功能；
### IM：
消息队列与websocket长连接，提供消息推送和削峰填谷功能；
基于位置的群消息（会包含用户及经纬度信息），写扩散；
单聊功能是双方的写扩散功能；聊天列表（包含用户信息和地理位置信息）；
群聚活动与娱乐场所推荐：
依然直接展示在地图上，在地图上冒泡高亮展示各个场所信息；
小程序只展示一页地图内容，所有功能基于地图展示；
### 日志
小程序客户端日志、服务端日志、后台管理日志；日志接口，推送日志数据到消息队列
### 用户注册
关于注册时手机验证：可以通过用户主动发送短信到公司的公共服务电话上，检查该号码收到的验证信息是否匹配，来确定是否是用户的手机；
微信上只需要用户授权即可，不需要发送短信验证；
### 高级功能
小程序的高级API需要使用公司资质；
### 婚恋玩法
用户确定分手：用户建立恋爱关系后，用户不允许使用软件的配对功能，除非用户双方确定分手，用户建立的恋爱关系上区块链记录；
## 商业化
区块链：婚姻证书上链（收取手续费用）；
广告埋点：需要把小程序先推广使用，产生用户，需要关注人数达到1000人，才能开通广告插件功能；通过看广告，来生产特权时间，获得商业价值；
## 运维
需要的资源：
域名：正是环境的微信小程序需要备案过的域名；
服务基础组件：消息队列NSQ或Kafka、redis、MySQL、MongoDB；
服务器资源：Kubernets云服务器；Nginx；
kubernets运维上线：
Golang应用程序代码、编写Dockerfile、使用Dockerfile与golang项目代码生成docker镜像、验证镜像、推送镜像到docker hub、编写部署清单文件deployment.yaml、kubectl create -f创建kurbenets对象、作为service对外暴露端口
## 项目工期
### 目标
四月份投放到市场进行推广验证；还需要开发的内容，前端动态展示用户，用户头像上传，维持长连接，用户发送消息；用户的消息在地图上展示，而不是在单独页面展示，用户头像上传为用户后台自动上传，不需要用户任何操作；封装常用函数和方法；
第一期功能：注册登陆、修改用户信息、展示用户在地图上的实时位置；
第二期功能：消息功能，用户实时发布消息并推送消息，消息列表在地图上轮播展示，查看过的消息标记清理；
第三期功能：娱乐场所推荐；
第四期功能：群聚功能，“呼朋唤友”；
第五期功能：婚恋；彩虹线；实名实人认证；
第六期功能：公告、地图动态、地图广播；
### 任务清单：
- [ ] 申请社交媒体资质，微信小程序地图插件；
- [ ] 小程序中使用的icon和程序logo；
- [ ] 提示用户订阅微信小程序通知消息；
- [ ] 用户的个人信息修改，需要找到激碰公司的地址，进入大楼，进行登记修改；地图始终显示定位按钮、前往总部（可登机修改头像和昵称信息）、群聚活动（点击后显示群聚地点和活动内容）、消息铃铛、娱乐场所推荐；
- [x] 用户可以设置自己的属性、微信号等内容进行展示；
- [x] 登陆后返回用户信息；
- [x] 修改用户信息时，提交属性信息，微信号；
- [x] marker平移动画；
- [x] 小程序广告的用法（需要成为流量主，访问量超过1k）
- [x] Jipeng服务端的配置做成配置文件
- [x] 查看小程序长连接的用法
- [x] 添加身份校验中间件
- [x] 个人信息页，判断点击事件的组件和是否是自己，获取用户信息事件，上传信息到服务器；
- [x] 客户端自动刷新地图上的用户，考虑使用mqtt发布订阅，或socket长连接，服务端数据变化后，主动推送客户端数据；或者用户点击组件后，再拉取数据；
- [x] Mongo查找指定位置范围内的用户（mongo没按要求返回数据）；
- [x] 注册登录逻辑判断；
- [x] 用户定时上传位置信息（改为后台监听用户位置变化，位置变化后触发位置上传）；
- [x] mongo的geo存储；
- [x] 微信小程序前端如何不断的上传数据到服务器（循环定时器）；
- [x] 询问英辉，关于IOS开发的过程，是不是和小程序一样，都是一些关于生命周期的钩子函数；
- [x] 前端地图组件；
- [x] 地图上展示多用户；
## 思考内容
### 使用本软件的用户基本需求思考：
设计激碰的产品形态和流程，首先用户注册登陆，需要注册用户的个人信息（避免重复获取用户信息，是否需要事实获取用户信息）；用户进入系统后，目标是找人，找最近出现在附近的人，所以需要获取用户的精准位置信息，还有在线时间，保持心跳（在线实时发送自己的位置信息），用户时空信息保存在缓存中，超时过期删除（后期可以考虑发送到mqtt和Kafka，将所有的用户轨迹记录，并做推荐使用）。UI方面，是否做底部Tab Bar，考虑不做Tab Bar，进入小程序后，用户可以看到的内容，考虑可以展示的东西，第一，地图上的人，人在地图上的状态信息，不需要用户提交，自动判断用户行为，也可以设置；第二，直接展示用户提交的音视频图像内容，距离和时间信息重点上浮在信息上层；这两种可能都不可取。首先用户需要的东西，第一层需求，可以马上见面办事，时间和空间合适；第二层，双方都相互看对眼，这里如何更好的让双方能看对眼；第三，安全问题，传染病，用户生命财产安全问题；第四，用户的健康体检报告，hpv疫苗接种情况，hiv和性病感染情况，实名、实人认证，封杀诈骗账户。首先两个用户的直线距离信息，第二，用户的真实影音信息，第三用户的基础属性信息，用户的健康属性信息；小窗地图展示两者见面的距离规划路线，同时展示两个用户提供的音视频资料（包含自己寻找的对象要求，对方的自身条件），自动播放对方，弹幕弹出用户的附加信息（身高体重年龄颜值大小皮肤肌肉体型），自身的信息不弹幕，只展示自身的诉求信息。对方的信息展示面积大于自身的信息展示面积；用户信息录入时，分段录入用户分类信息并最终按整体来生成展示视频，比如发型脸型颜值体型身高和身材尺寸和皮肤手指甲，生成的视频自动播放，并自动发弹幕给用户查看。关于连线和移除操作，点击地图路线后动画转场跳转进入3维实景地图导航，头像上弹出实时的消息发送信息，在距离临近时对方会震动或发出声音，提示对方已到达，游戏画质和渲染能力。不存在群聊，只存在于地图上用户的人形上方的消息栏，可以发送文字和语音（不支持视频），多人同时发送文字和语音会同时展示文字和同时混音播放视频；进入3维地图导航以后，用户可以通过手势缩放，在地图上找人，查看各自的位置和语音文字消息。
### 需要用到游戏的高桢高画质和实时渲染能力；
按以上的流程，用户使用产品的生命周期是，打开小程序自动注册，配置自己的需求和资料，进入无限轮播推荐页（掠过和选中交互策略未明确），实际上是为了解决人与人之间的社恐，增加人和人之间接触和见面交流的机会。
在指定范围内的用户中，找到和用户理想型相似度最高的用户，然后推荐给用户。筛选的过程，实际上不应该是用户自己来做，而是我们通过计算机的算法，将匹配度较高的用户勾搭在一起。所以，整个流程，都应该是以用户最终走到一起为目标。不要让用户做选择题。用户进入程序，就应该直接看见他想要的人的信息：地图位置、颜值、衣品、外型，可以展示用户信息的output方式（视频、声音、图片、文字），地图使用数据；
推视频和推人的区别：一个人只能是一个人，一个人可以产生多个视频；是否可以重复匹配，肯定是可以的，因为人会变化成长，改变后的人，可能又会重新喜欢上。
考虑到微信小程序对用户信息、位置信息获取的限制，后期要考虑开发ios的app。
关于第二维度，用户匹配度；用户想要的东西是什么？一个满足他性需求、性癖需求的人；这个人从哪儿来？虚假的，真实的。
### IM开发：
基于消息队列，websocket或socket长连接，服务端主动推送消息给客户端，或者基于mqtt消息发布订阅实现；连接管理，长连接需要心跳保持，如果判断用户不在线后，需要断开连接，并且对消息队列中的数据，进行存档处理，用户上线后再次推送；群消息是一个写扩散的过程；暂时不提供群聊功能；
不需要太强大的IM功能，只需要推送用户消息即可；因为用户可以自行加微信，用户在小程序网页上进行IM收发消息体验也太差；只需要及时推送用户之间的留言即可；用户上线后，就推送数据；
用户发送的消息会直接推送到消息队列；消息队列的数据再由消费者经过分发，发送到对应用户的队列，然后长连接取用户的消息队列消息，返回给前端；
前端的UI组件需要包含：会话列表、对话框；这种传统的方式，没有什么好玩的；还是需要在地图上自动展示弹出用户消息；用户消息分为两种，一种是地图广播，另外一种私信消息；地图广播消息，可以通过用户窗口事件和位置变化事件触发，由客户端主动拉数据；私信消息，使用长连接，只发送给私信接收方；前端UI和动画的问题；预留语音消息和视频消息、图片消息，先实现文字消息；websocket，第一步是判断服务端是否支持websocket协议；websocket握手使用http upgrade机制；
引入聊天房间概念，不管是单聊还是多人聊天，都是建立一个聊天室，用户向该聊天室发送消息，房间内的人订阅接收；聊天室表、聊天室用户表、聊天室消息历史表(Mongo)；
前端IM发送消息：点击label和点击callout后的回调事件，展示发送消息组件，文字、图片、语音、视频、邀约等；接收方在小程序端有个消息按钮，点击后，更新地图上的markers，只展示未读消息人的位置，地图缩放；
### 地图开发：
将当前用户的位置展示在地图上；
将当前位置内存在的用户添加到地图上，用户发布的内容（文字、图片、语音、视频），在地图上用户所在的位置上自动轮播；点击地图上的其他用户后，进入规划路线；地图默认展示范围，只展示附近多少米的面积，对于位置相同的人，根据权重取分值最高的用户；地图不允许缩放，只允许滑动，可以展示当前附近有多少人；
地图上用户和轮播的信息框大小，需要考虑大小和展示方式。
用户点击其他用户后，判断当前用户的状态，在线用户直接连线在地图图层上进行视频聊天。不跳转页面。
地图页面需要与服务器保持长连接，服务端需要推送用户数据到客户端；前端需要修改marker的样式，配置地图展示范围；
用户拉取当前页面范围的用户（注册需要存储头像、昵称）及位置信息：事件触发，当位置变化，用户操作窗口事件，都会拉取最新的周围用户，使用socket进行消息推送（查找最近范围内的用户，主动添加自己的信息到对方的可见列表中）消耗太大；
微信小程序的地图功能：点聚合，用于marker过多场景；彩虹蚯蚓线，路线规划；覆盖物支持与其他地图元素的压盖关系；支持marker平移动画，适用于轨迹回放场景；
封装地图上marker更新方法，marker的id就是用户ID；
画路线图，封装修改地图的polyline方法；bindtap是点击地图时绑定的事件处理函数；
原则，不要离开地图页面，map组件上增加显示和隐藏蒙层；图片不展示;marker上的气泡，使用自定义气泡，需要展示更多信息，比如换行，添加用户的属性，用户发送的文字、语音、视频；title与callout不能同时显示；关于label，是一个标签；callout用于轮播展示用户发送的消息广播；label用于展示用户的属性信息；
消息框配色问题，优先级高于头像和用户属性；
### 前端：
头像设置：用户第一次登陆成功后，同步用户头像，头像提交成功后，上传头像组件销毁或隐藏；用户每次重新进入小程序，都需要重新提交用户信息，原因是用户有约炮需求，会不断调整自己的头像来提升自己的吸引力；点击并长按用户头像，开始展示用户个人信息组件，组件中可以自动轮播图片、自动播放视频，昵称、年龄等文字信息，浮于视频组件上方，以弹幕的形式循环播放；手指松开屏幕，用户信息组件自动消失；
风格一定要简洁，只提供用户需要的功能，和微信一样确定好的功能，不能轻易变动，对老用户不友好；
结婚后，两个用户的头像之间会一直有一条彩虹线链接；
用户个人信息：
地图上marker展示的头像，提供动图、花边等显示功能；
点击用户头像后，显示发送语音消息按钮，实时推送识别出的数据发给用户；前期只支持文字发送；消息服务器，将消息发送到websocket服务器，websocket服务将消息投递到MQ，由消息分发服务订阅MQ处理成客户端接收的消息体，投递到websocket服务器订阅的发送客户端数据的消息队列，websocket订阅该消息队列，直接投递消息给客户端；
视频、图片、音频上传，保存到文件存储服务器，scroll-view组件可以实现轮播功能；share-element可以在多个页面间共享一个组件，比如客服悬浮按钮；
视频推流：Nginx可作为视频推流服务器；视频拉流：

