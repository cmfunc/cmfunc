# 常见的垃圾回收算法

## 1. 引用计数

代表语言: Python

[Python垃圾回收官方文档](https://docs.python.org/3/library/gc.html)

Python 使用「引用计数」进行垃圾回收，通过「标记-清理」解决「容器对象」产生循环引用的问题，通过分代回收以空间换时间的方式来提高垃圾回收的效率。

### 1.1 Python引用计数

CPython源码中，Python对象的核心是PyObject结构体，该结构体通过ob_refcnt实现变量的引用计数

```c
typedef struct_object {
    int ob_refcnt;
    struct_typeobject *ob_type;
} PyObject;
```

循环引用导致变量引用计数永不为0，造成引用计数无法将其删除；

```python
a=[1,2] # 计数为 1
b=[2,3] # 计数为 1
a.append(b) # 计数为 2
b.append(a) # 计数为 2
DEL a # 计数为 1
DEL b # 计数为 1
```

### 1.2 Python 标记-清除

Python使用标记-清除的方式来解决循环引用导致的问题；只有容器对象才会产生循环引用的情况。

1. 标记阶段：遍历所有对象，如果是可达的（reachable），还有对象引用它，那么就标记该对象为可达；
1. 清除阶段：再次遍历对象，如果发现某个对象没有标记为可达，则就将其回收；

标记清除算法中，为了追踪容器对象，需要每个容器对象维护两个额外的指针，用来将容器对象组成一个双端链表，指针分别指向前后两个容器对象，方便插入和删除。

Cpython维护了两个这样的双端链表，一个链表存放着需要被扫描的容器对象，称为``Object to Scan``，另一个链表存放着临时不可达对象，称为Unreachable。

### 1.3 分代回收

分代回收基于一个统计事实，对于程序，存在一定比例的内存块的生命周期比较短；而剩下的内存块，生命周期会比较长，甚至会从程序开始一直持续到程序结束。

生命周期短的对象所在比例在``80% ~ 90%``之间，这种思想简单理解即：对象存在时间越长，越可能不是垃圾，应该越少去收集，这样执行标记-清除算法时可以有效减小遍历的对象数，从而提高垃圾回收的速度。

python gc 给对象定义了三种世代（0，1，2），每一个新生对象在generation zero中，如果它在一轮gc扫描中活了下来，那么它将被移至generation one，在那里他将较少的被扫描，如果它又活过了一轮gc，它将被移至generation two，在那里它被扫描的次数将会更少。

当某一世代被分配的对象与被释放的对象之差达到某一阈值的时候，就会触发 gc 对某一世代的扫描。值得注意的是当某一世代的扫描被触发的时候，比该世代年轻的世代也会被扫描?。也就是说如果世代 2 的 gc 扫描被触发了，那么世代 0, 世代 1 也将被扫描，如果世代 1 的 gc 扫描被触发，世代 0 也会被扫描。

## 2. 三色标记

代表语言: Golang

三色标记属于``追踪式垃圾回收（tracing garbage collection）``算法的一种；
追踪式算法的核心：判断一个对象是否可达，一旦对象不可达就立刻被GC回收。第一步，找出所有的全局变量和当前函数栈里的变量，标记为可达；第二步，从已经标记的数据开始，进一步标记它们可访问的变量，以此类推，专业术语叫传递闭包。

三色标记之前有个算法叫``Mark-And-Sweep(标记清扫)``，这个算法是严格按照追踪式算法的思路来实现的，最开始所有标记位都是0，如果发现对象可达标记为1，一步步下去就会呈现一个类似树状的结果。

标记清扫算法，在GC执行阶段需要把整个程序完全暂停，不能异步进行GC操作。

### 2.1 三色标记的优点

相比传统的标记清扫算法，三色标记可以异步执行，从而可以以中断时间极少的代价或者完全没有中断来进行整个GC。

### 2.2 三色标记原理

首先将对象用三种颜色表示，分别为白色、灰色和黑色。最开始所有对象都是白色，然后把其中全局变量和函数栈里的对象置为灰色

### 2.3 Golang GC 演变

- v1.3以前 标记-清除算法
- v1.3 简单优化，将STW提前，减少STW暂停的时间范围
- v1.5 三色并发标记

[刘丹冰博客](<https://www.jianshu.com/p/4c5a303af470>)

#### 2.3.1 ``三色标记法`` 是通过三个阶段来确定清除的对象有哪些

#### 2.3.2 屏障机制

打破必须强制STW的机制；

- 强三色不变式:不存在黑色对象引用到白色对象的指针
- 弱三色不变式:所有被黑色对象引用的白色对象都处于灰色保护状态

##### 2.3.1.1 插入屏障

##### 2.3.1.2 删除屏障

#### 2.3.3 Go v1.8 混合写屏障（hybrid write barrier）机制

- 插入写屏障：结束时需要STW来重新扫描栈，标记栈上引用的白色对象的存活；
- 删除写屏障：回收精度低，GC开始时STW扫描堆栈来记录初始快照，这个过程会保护开始时刻的所有存活对象。

混合写屏障规则：

1. GC开始将栈上的对象全部扫描并标记为黑色(之后不再进行第二次重复扫描，无需STW)。
1. GC期间，任何在栈上创建的新对象，均为黑色。
1. 被删除的对象标记为灰色。
1. 被添加的对象标记为灰色。

混合写屏障满足``变形的弱三色不变式``；屏障技术不在栈上应用，因为要保证栈的运行效率。
混合写屏障是gc的一种屏障机制，只有当程序执行GC的时候，才会触发这种机制。

## 3. 分代回收

代表语言: Java
